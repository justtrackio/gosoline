"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[7363],{7759(e,n,o){o.r(n),o.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>m,frontMatter:()=>c,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"quickstart/create-a-consumer","title":"Create a consumer","description":"One of the primary use cases for gosoline is to create a message queue consumer. In this tutorial, you\'ll do just that!","source":"@site/docs/quickstart/create-a-consumer.mdx","sourceDirName":"quickstart","slug":"/quickstart/create-a-consumer","permalink":"/gosoline/quickstart/create-a-consumer","draft":false,"unlisted":false,"editUrl":"https://github.com/justtrackio/gosoline/tree/main/docs/docs/quickstart/create-a-consumer.mdx","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2,"title":"Create a consumer"},"sidebar":"docSidebar","previous":{"title":"Write a CRUD SQL app","permalink":"/gosoline/quickstart/http-server/write-crud-sql-app"},"next":{"title":"Create an application","permalink":"/gosoline/quickstart/create-an-application"}}');var s=o(4848),r=o(8453),i=o(3457);const c={sidebar_position:2,title:"Create a consumer"},l=void 0,a={},d=[{value:"Before you begin",id:"before-you-begin",level:2},{value:"Set up your file structure",id:"set-up-your-file-structure",level:2},{value:"Implement consumer.go",id:"implement-consumergo",level:2},{value:"Import dependencies",id:"import-dependencies",level:3},{value:"Implement your data structs",id:"implement-your-data-structs",level:3},{value:"Implement <code>Consumer</code> methods",id:"implement-consumer-methods",level:3},{value:"Implement <code>main.go</code>",id:"implement-maingo",level:2},{value:"Configure your consumer",id:"configure-your-consumer",level:2},{value:"Add your data",id:"add-your-data",level:2},{value:"Test your consumer",id:"test-your-consumer",level:2},{value:"Conclusion",id:"conclusion",level:2}];function u(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components},{Details:o}=n;return o||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"One of the primary use cases for gosoline is to create a message queue consumer. In this tutorial, you'll do just that!"}),"\n",(0,s.jsxs)(n.p,{children:["To build a consumer of async message queues you'll' implement the ",(0,s.jsx)(n.code,{children:"ConsumerCallback"})," interface of the ",(0,s.jsx)(n.code,{children:"stream"})," package."]}),"\n",(0,s.jsx)(n.h2,{id:"before-you-begin",children:"Before you begin"}),"\n",(0,s.jsxs)(n.p,{children:["Before you begin, make sure you have ",(0,s.jsx)(n.a,{href:"https://go.dev/doc/install",children:"Golang"})," installed on your machine."]}),"\n",(0,s.jsx)(n.h2,{id:"set-up-your-file-structure",children:"Set up your file structure"}),"\n",(0,s.jsx)(n.p,{children:"First, you need to set up the following file structure:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-txt",children:"consumer/\n\u251c\u2500\u2500 consumer.go\n\u251c\u2500\u2500 main.go\n\u251c\u2500\u2500 events.json\n\u2514\u2500\u2500 config.dist.yml\n"})}),"\n",(0,s.jsx)(n.p,{children:"For example, in Unix, run:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"mkdir consumer; cd consumer\ntouch consumer.go\ntouch main.go\ntouch events.json\ntouch config.dist.yml\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Those are all the files you need to build your first consumer with gosoline! Next, you'll implement each of these files, starting with ",(0,s.jsx)(n.code,{children:"consumer.go"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"implement-consumergo",children:"Implement consumer.go"}),"\n",(0,s.jsxs)(n.p,{children:["In ",(0,s.jsx)(n.code,{children:"consumer.go"}),", add the following code:"]}),"\n",(0,s.jsxs)(o,{children:[(0,s.jsx)("summary",{children:"consumer.go"}),(0,s.jsx)("p",{children:(0,s.jsx)(i.A,{showLineNumbers:!0,language:"go",children:'package main\n\nimport (\n\t"context"\n\n\t"github.com/justtrackio/gosoline/pkg/cfg"\n\t"github.com/justtrackio/gosoline/pkg/log"\n\t"github.com/justtrackio/gosoline/pkg/stream"\n)\n\ntype Input struct {\n\tId   string `json:"id"`\n\tBody string `json:"body"`\n}\n\ntype Consumer struct {\n\tlogger log.Logger\n}\n\nfunc NewConsumer(ctx context.Context, config cfg.Config, logger log.Logger) (stream.ConsumerCallback[Input], error) {\n\treturn &Consumer{\n\t\tlogger: logger,\n\t}, nil\n}\n\nfunc (c Consumer) Consume(ctx context.Context, input Input, attributes map[string]string) (bool, error) {\n\tc.logger.Info(ctx, "got input with id %q and body %q", input.Id, input.Body)\n\n\treturn true, nil\n}\n'})})]}),"\n",(0,s.jsx)(n.p,{children:"Now, you'll walkthrough this file in detail to learn how it works."}),"\n",(0,s.jsx)(n.h3,{id:"import-dependencies",children:"Import dependencies"}),"\n",(0,s.jsxs)(n.p,{children:["At the top of ",(0,s.jsx)(n.code,{children:"consumer.go"}),", you declared the package and imported some dependencies:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",metastring:"title=consumer.go",children:'package main\n\nimport (\n\t"context"\n\n\t"github.com/justtrackio/gosoline/pkg/cfg"\n\t"github.com/justtrackio/gosoline/pkg/log"\n\t"github.com/justtrackio/gosoline/pkg/stream"\n)\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Here, you declared the package as ",(0,s.jsx)(n.code,{children:"main"}),". Then, you imported the ",(0,s.jsx)(n.code,{children:"context"})," module along with three gosoline dependencies:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/reference/package-cfg",children:(0,s.jsx)(n.code,{children:"cfg"})})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/reference/package-log",children:(0,s.jsx)(n.code,{children:"log"})})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"stream"})}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"implement-your-data-structs",children:"Implement your data structs"}),"\n",(0,s.jsxs)(n.p,{children:["Then, you created an ",(0,s.jsx)(n.code,{children:"Input"})," struct and a ",(0,s.jsx)(n.code,{children:"Consumer"})," struct:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",metastring:"title=consumer.go",children:'// 1\ntype Input struct {\n\tId   string `json:"id"`\n\tBody string `json:"body"`\n}\n\n// 2\ntype Consumer struct {\n\tlogger log.Logger\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"You'll use these to:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Bind data from the message queue. Note that you read an ",(0,s.jsx)(n.code,{children:"id"})," and ",(0,s.jsx)(n.code,{children:"body"})," from Json keys."]}),"\n",(0,s.jsx)(n.li,{children:"Store logger information about your consumer."}),"\n"]}),"\n",(0,s.jsxs)(n.h3,{id:"implement-consumer-methods",children:["Implement ",(0,s.jsx)(n.code,{children:"Consumer"})," methods"]}),"\n",(0,s.jsxs)(n.p,{children:["Next, you implemented some methods for the ",(0,s.jsx)(n.code,{children:"Consumer"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",metastring:"title=consumer.go",children:'// 1\nfunc NewConsumer(ctx context.Context, config cfg.Config, logger log.Logger) (stream.ConsumerCallback, error) {\n\treturn &Consumer{\n\t\tlogger: logger,\n\t}, nil\n}\n\n// 2\nfunc (c Consumer) GetModel(attributes map[string]any) any {\n\treturn &Input{}\n}\n\n// 3\nfunc (c Consumer) Consume(ctx context.Context, model any, attributes map[string]any) (bool, error) {\n\tinput := model.(*Input)\n\n\tc.logger.WithContext(ctx).Info("got input with id %q and body %q", input.Id, input.Body)\n\n\treturn true, nil\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Here, you implemented:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["A constructor for creating new ",(0,s.jsx)(n.code,{children:"Consumer"})," objects. This implements the ",(0,s.jsx)(n.code,{children:"stream.ConsumerCallbackFactory"})," type and is used to add the callback to your application."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"GetModal()"}),", a method that returns the expected input model struct which is used to unmarshal the\ndata."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"Consume()"}),", a method that loads the model (",(0,s.jsx)(n.code,{children:"Input"}),") with data, logs the data, and returns ",(0,s.jsx)(n.code,{children:"true"})," because it successfully handled the message. This is called for every incoming message."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Together, these methods implement the ",(0,s.jsx)(n.code,{children:"ConsumerCallback"})," interface."]}),"\n",(0,s.jsxs)(n.h2,{id:"implement-maingo",children:["Implement ",(0,s.jsx)(n.code,{children:"main.go"})]}),"\n",(0,s.jsxs)(n.p,{children:["In ",(0,s.jsx)(n.code,{children:"main.go"}),", add the following code:"]}),"\n",(0,s.jsx)(i.A,{showLineNumbers:!0,language:"go",title:"main.go",children:'package main\n\nimport "github.com/justtrackio/gosoline/pkg/application"\n\nfunc main() {\n\tapplication.RunConsumer(NewConsumer)\n}\n'}),"\n",(0,s.jsxs)(n.p,{children:["Here, you execute your consumer. ",(0,s.jsx)(n.code,{children:"RunConsumer()"})," expects a parameter of the type ",(0,s.jsx)(n.code,{children:"stream.ConsumerCallbackFactory"})," to create and run the consumer. ",(0,s.jsx)(n.code,{children:"NewConsumer()"})," implements this interface."]}),"\n",(0,s.jsx)(n.h2,{id:"configure-your-consumer",children:"Configure your consumer"}),"\n",(0,s.jsxs)(n.p,{children:["In ",(0,s.jsx)(n.code,{children:"config.dist.yml"}),", configure your server:"]}),"\n",(0,s.jsx)(i.A,{showLineNumbers:!0,language:"yaml",title:"config.dist.yml",children:"env: dev\napp_project: gosoline\napp_family: how-to\napp_group: grp\napp_name: consumer\n\nstream:\n  input:\n    consumer:\n      type: file\n      filename: events.json"}),"\n",(0,s.jsxs)(n.p,{children:["Here, you set some minimal configurations for your web server. By default, the gosoline expects that there is an input configured with the config key ",(0,s.jsx)(n.code,{children:"stream.input.consumer"}),'. This defines the input source. In this tutorial, you\'ll use a file as source with the configured filename, "events.json".']}),"\n",(0,s.jsx)(n.h2,{id:"add-your-data",children:"Add your data"}),"\n",(0,s.jsxs)(n.p,{children:["In ",(0,s.jsx)(n.code,{children:"events.json"}),", add some mock events stream data:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{"body": "{\\"id\\": \\"1a0a960f-f04f-4c41-9b9a-a5ca0e2637b2\\", \\"body\\": \\"Lorem ipsum dolor sit amet.\\"}"}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Now, the final step is to test it to confirm that it works as expected."}),"\n",(0,s.jsx)(n.h2,{id:"test-your-consumer",children:"Test your consumer"}),"\n",(0,s.jsxs)(n.p,{children:["In the ",(0,s.jsx)(n.code,{children:"consumer"})," directory, run:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"go mod init consumer/m\ngo mod tidy\ngo run .\n"})}),"\n",(0,s.jsx)(n.p,{children:"In the output, you'll see a log that indicates your consumer handled the event data:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:'10:23:57.648 consumerCallback info    got input with id "1a0a960f-f04f-4c41-9b9a-a5ca0e2637b2" and body "Lorem ipsum dolor sit amet."  application: consumer\n'})}),"\n",(0,s.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,s.jsx)(n.p,{children:"That's it! You created your first gosoline message queue consumer."})]})}function m(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(u,{...e})}):u(e)}}}]);