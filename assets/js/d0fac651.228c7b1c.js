"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[9997],{9491(e,l,o){o.r(l),o.d(l,{assets:()=>c,contentTitle:()=>r,default:()=>d,frontMatter:()=>a,metadata:()=>n,toc:()=>p});const n=JSON.parse('{"id":"how-to/write-health-checks","title":"Implement health checks","description":"You can check the health of a running gosoline application.","source":"@site/docs/how-to/write-health-checks.mdx","sourceDirName":"how-to","slug":"/how-to/write-health-checks","permalink":"/gosoline/how-to/write-health-checks","draft":false,"unlisted":false,"editUrl":"https://github.com/justtrackio/gosoline/tree/main/docs/docs/how-to/write-health-checks.mdx","tags":[],"version":"current","frontMatter":{"title":"Implement health checks"},"sidebar":"docSidebar","previous":{"title":"Use sampling","permalink":"/gosoline/how-to/sampling/use-sampling"},"next":{"title":"Write integration tests","permalink":"/gosoline/how-to/write-integration-tests"}}');var t=o(4848),h=o(8453),i=o(3457);const a={title:"Implement health checks"},r=void 0,c={},p=[{value:"Check your application on run",id:"check-your-application-on-run",level:2},{value:"Check your app&#39;s health manually",id:"check-your-apps-health-manually",level:2},{value:"Customize your health check",id:"customize-your-health-check",level:2},{value:"Implement module.go",id:"implement-modulego",level:3}];function s(e){const l={code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,h.R)(),...e.components},{Details:o}=l;return o||function(e,l){throw new Error("Expected "+(l?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(l.p,{children:"You can check the health of a running gosoline application."}),"\n",(0,t.jsx)(l.p,{children:"In this guide, you'll learn how to:"}),"\n",(0,t.jsxs)(l.ul,{children:["\n",(0,t.jsx)(l.li,{children:"Configure and use the on-run health check."}),"\n",(0,t.jsx)(l.li,{children:"Configure and use the health-check endpoint."}),"\n",(0,t.jsx)(l.li,{children:"Customize a module's health-check behavior."}),"\n"]}),"\n",(0,t.jsx)(l.h2,{id:"check-your-application-on-run",children:"Check your application on run"}),"\n",(0,t.jsx)(l.p,{children:'When you run your application, the kernel automatically performs a health check. After you call run, the application transitions into the "running" state only after all modules are considered healthy. You can configure the timing behavior of this health check like this:'}),"\n",(0,t.jsx)(l.pre,{children:(0,t.jsx)(l.code,{className:"language-yaml",children:"kernel:\n  health_check:    \n    timeout: 10s    \n    wait_interval: 1s\n"})}),"\n",(0,t.jsx)(l.p,{children:"Here, you:"}),"\n",(0,t.jsxs)(l.ol,{children:["\n",(0,t.jsx)(l.li,{children:"Configure an on-run health check."}),"\n",(0,t.jsx)(l.li,{children:"Establish a timeout for the health check."}),"\n",(0,t.jsx)(l.li,{children:"Establish a one-second wait interval before checking or re-checking if the app is healthy."}),"\n"]}),"\n",(0,t.jsxs)(l.p,{children:["The ",(0,t.jsx)(l.code,{children:"kernel.health_check.wait_interval"})," is used to verify that all modules are healthy. If they are not all healthy by the time the ",(0,t.jsx)(l.code,{children:"kernel.health_check.timeout"})," is reached, the application stops. Once the application is considered healthy on run, the kernel no longer performs its own health checks."]}),"\n",(0,t.jsx)(l.p,{children:"Therefore, to check the health of your application once it's running, you need to use the health-check endpoint."}),"\n",(0,t.jsx)(l.h2,{id:"check-your-apps-health-manually",children:"Check your app's health manually"}),"\n",(0,t.jsx)(l.p,{children:"Once your application is running, you can perform a health check with a simple HTTP request to its health-check endpoint:"}),"\n",(0,t.jsx)(l.pre,{children:(0,t.jsx)(l.code,{className:"language-http",children:"GET /health HTTP/1.1\nHost: localhost:8090\n"})}),"\n",(0,t.jsx)(l.p,{children:"You can configure the health-check path and port with the following configuration:"}),"\n",(0,t.jsx)(l.pre,{children:(0,t.jsx)(l.code,{className:"language-yaml",children:"httpserver:\n  health-check:\n    path: /health\n    port: 8090\n"})}),"\n",(0,t.jsxs)(l.p,{children:["By default, this route responds with a ",(0,t.jsx)(l.code,{children:"200 OK"})," status code if the application is considered healthy."]}),"\n",(0,t.jsxs)(l.p,{children:["If you want to have more control over the module's health status, you can implement the ",(0,t.jsx)(l.code,{children:"kernel.HealthChecked"})," interface for your application modules."]}),"\n",(0,t.jsx)(l.h2,{id:"customize-your-health-check",children:"Customize your health check"}),"\n",(0,t.jsxs)(l.p,{children:["To control how the health of your application is verified, you'll implement the ",(0,t.jsx)(l.code,{children:"kernel.HealthChecked"})," interface:"]}),"\n",(0,t.jsx)(l.pre,{children:(0,t.jsx)(l.code,{className:"language-go",children:"package kernel\n\ntype HealthCheckedModule interface {\n\tIsHealthy(ctx context.Context) (bool, error)\n}\n"})}),"\n",(0,t.jsxs)(l.p,{children:["Here you'll walk through a complete example application of how you might implement this interface, starting with ",(0,t.jsx)(l.code,{children:"module.go"}),"."]}),"\n",(0,t.jsx)(l.h3,{id:"implement-modulego",children:"Implement module.go"}),"\n",(0,t.jsxs)(l.p,{children:["In ",(0,t.jsx)(l.code,{children:"module.go"}),", add the following code:"]}),"\n",(0,t.jsxs)(o,{children:[(0,t.jsx)("summary",{children:"module.go"}),(0,t.jsx)("p",{children:(0,t.jsx)(i.A,{showLineNumbers:!0,language:"go",children:'package main\n\nimport (\n\t"context"\n\t"sync/atomic"\n\t"time"\n\n\t"github.com/justtrackio/gosoline/pkg/cfg"\n\t"github.com/justtrackio/gosoline/pkg/clock"\n\t"github.com/justtrackio/gosoline/pkg/kernel"\n\t"github.com/justtrackio/gosoline/pkg/log"\n)\n\nfunc NewHelloWorldModule(ctx context.Context, config cfg.Config, logger log.Logger) (kernel.Module, error) {\n\treturn &HelloWorldModule{\n\t\tlogger: logger.WithChannel("hello-world"),\n\t}, nil\n}\n\ntype HelloWorldModule struct {\n\tlogger  log.Logger\n\thealthy atomic.Bool\n}\n\nfunc (h *HelloWorldModule) IsHealthy(ctx context.Context) (bool, error) {\n\treturn h.healthy.Load(), nil\n}\n\nfunc (h *HelloWorldModule) Run(ctx context.Context) error {\n\ttimer := clock.NewRealTimer(time.Second * 3)\n\t<-timer.Chan()\n\n\th.healthy.Store(true)\n\n\th.logger.Info(ctx, "Hello World")\n\n\treturn nil\n}\n'})})]}),"\n",(0,t.jsx)(l.p,{children:"Now, you'll walkthrough this file in detail to learn how it works."}),"\n",(0,t.jsxs)(l.p,{children:["First, you declare ",(0,t.jsx)(l.code,{children:"healthy"}),", a boolean to store the health of the module:"]}),"\n",(0,t.jsx)(l.pre,{children:(0,t.jsx)(l.code,{className:"language-go",metastring:"title=module.go",children:"type HelloWorldModule struct {\n\tlogger log.Logger\n  // highlight-next-line\n\thealthy atomic.Bool\n}\n"})}),"\n",(0,t.jsxs)(l.p,{children:["Then, you implement ",(0,t.jsx)(l.code,{children:"IsHealthy()"}),", a function that gets called on every health check:"]}),"\n",(0,t.jsx)(l.pre,{children:(0,t.jsx)(l.code,{className:"language-go",metastring:"title=module.go",children:"func (h *HelloWorldModule) IsHealthy(ctx context.Context) (bool, error) {\n\treturn h.healthy.Load(), nil\n}\n"})}),"\n",(0,t.jsxs)(l.p,{children:["Next, you add a timer that simulates some work that has to be done before the module is considered healthy, then set ",(0,t.jsx)(l.code,{children:"healthy"})," to ",(0,t.jsx)(l.code,{children:"true"}),":"]}),"\n",(0,t.jsx)(l.pre,{children:(0,t.jsx)(l.code,{className:"language-go",metastring:"title=module.go",children:'func (h *HelloWorldModule) Run(ctx context.Context) error {\n  // highlight-start\n\ttimer := clock.NewRealTimer(time.Second * 3)\n\t<-timer.Chan()\n\n\th.healthy.Store(true)\n\t// highlight-end\n\n\th.logger.Info(ctx, "Hello World")\n\n\treturn nil\n}\n'})}),"\n",(0,t.jsx)(l.p,{children:"And that's it! You've implemented custom health-check logic in your module."}),"\n",(0,t.jsxs)(l.p,{children:["Now, add your app's ",(0,t.jsx)(l.code,{children:"main.go"})," file:"]}),"\n",(0,t.jsxs)(o,{children:[(0,t.jsx)("summary",{children:"main.go"}),(0,t.jsx)("p",{children:(0,t.jsx)(i.A,{showLineNumbers:!0,language:"go",children:'package main\n\nimport "github.com/justtrackio/gosoline/pkg/application"\n\nfunc main() {\n\tapplication.RunModule("hello-world", NewHelloWorldModule)\n}\n'})})]}),"\n",(0,t.jsx)(l.p,{children:"Then, add your app's configuration, including health-checks:"}),"\n",(0,t.jsxs)(o,{children:[(0,t.jsx)("summary",{children:"config.dist.yml.go"}),(0,t.jsx)("p",{children:(0,t.jsx)(i.A,{showLineNumbers:!0,language:"yaml",children:"env: dev\napp_project: gosoline\napp_family: how-to\napp_group: health-check\napp_name: hello-world\n\nhttpserver:\n  // highlight-start\n  health-check:\n    path: /health\n    port: 8090\n  // highlight-end\n\nkernel:\n  // highlight-start\n  health_check:\n    timeout: 10s\n    wait_interval: 1s\n  // highlight-end\n"})})]}),"\n",(0,t.jsx)(l.p,{children:"And when you run your app, you'll see something like the following output:"}),"\n",(0,t.jsx)(i.A,{showLineNumbers:!0,language:"text",title:"stdout",children:"13:34:26.600 main    info    applied priority 8 config post processor 'gosoline.log.handler_main'  application: hello-world, group: health-check\n13:34:26.601 main    info    applied priority 1 config post processor 'gosoline.dx.autoCreate'  application: hello-world, group: health-check\n13:34:26.601 main    info    applied priority 1 config post processor 'gosoline.dx.useRandomPort'  application: hello-world, group: health-check\n12:34:26.604 kernel  info    starting kernel                                     application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg api.health.path=/health                         application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg api.health.port=8090                            application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg app_family=how-to                               application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg app_group=health-check                          application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg app_name=hello-world                            application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg app_project=gosoline                            application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg appctx.metadata.server.port=0                   application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg dx.auto_create=true                             application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg dx.use_random_port=true                         application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg env=dev                                         application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg kernel.health_check.timeout=10s                 application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg kernel.health_check.wait_interval=1s            application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg kernel.kill_timeout=10s                         application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg log.handlers.main.formatter=console             application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg log.handlers.main.level=info                    application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg log.handlers.main.timestamp_format=15:04:05.000  application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg log.handlers.main.type=iowriter                 application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg log.handlers.main.writer=stdout                 application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg metric.application={app_name}                   application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg metric.cloudwatch.naming.pattern={project}/{env}/{family}/{group}-{app}  application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg metric.enabled=false                            application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg metric.environment={env}                        application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg metric.family={app_family}                      application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg metric.group={app_group}                        application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg metric.interval=1m0s                            application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg metric.project={app_project}                    application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg metric.writer=                                  application: hello-world, group: health-check\n12:34:26.604 kernel  info    cfg fingerprint: ef5386d483b4b86e621859e38ecf2442   application: hello-world, group: health-check\n12:34:26.604 kernel  info    stage 0 up and running with 1 modules               application: hello-world, group: health-check\n12:34:26.604 kernel  info    running background module metric in stage 0         application: hello-world, group: health-check\n12:34:26.605 kernel  info    running background module metadata-server in stage 1024  application: hello-world, group: health-check\n12:34:26.605 kernel  info    running background module api-health-check in stage 1024  application: hello-world, group: health-check\n12:34:26.605 metrics info    metrics not enabled..                               application: hello-world, group: health-check\n12:34:26.605 kernel  info    stopped background module metric                    application: hello-world, group: health-check\n12:34:26.605 kernel  info    stage 1024 up and running with 2 modules            application: hello-world, group: health-check\n12:34:26.605 kernel  info    waiting for module hello-world in stage 2048 to get healthy  application: hello-world, group: health-check\n12:34:26.605 kernel  info    running foreground module hello-world in stage 2048  application: hello-world, group: health-check\n12:34:26.605 metadata-server info    serving metadata on address [::]:44891              application: hello-world, group: health-check\n12:34:27.605 kernel  info    waiting for module hello-world in stage 2048 to get healthy  application: hello-world, group: health-check\n12:34:28.606 kernel  info    waiting for module hello-world in stage 2048 to get healthy  application: hello-world, group: health-check\n12:34:29.606 hello-world info    Hello World                                         application: hello-world, group: health-check\n12:34:29.606 kernel  info    stopped foreground module hello-world               application: hello-world, group: health-check\n12:34:29.606 kernel  info    stage 2048 up and running with 1 modules            application: hello-world, group: health-check\n12:34:29.606 kernel  info    kernel up and running                               application: hello-world, group: health-check\n12:34:29.606 kernel  info    stopping kernel due to: no more foreground modules in running state  application: hello-world, group: health-check\n12:34:29.606 kernel  info    stopping stage 2048                                 application: hello-world, group: health-check\n12:34:29.606 kernel  info    stopped stage 2048                                  application: hello-world, group: health-check\n12:34:29.606 kernel  info    stopping stage 1024                                 application: hello-world, group: health-check\n12:34:29.607 kernel  info    stopped background module api-health-check          application: hello-world, group: health-check\n12:34:29.607 kernel  info    stopped background module metadata-server           application: hello-world, group: health-check\n12:34:29.607 kernel  info    stopped stage 1024                                  application: hello-world, group: health-check\n12:34:29.607 kernel  info    stopping stage 0                                    application: hello-world, group: health-check\n12:34:29.607 kernel  info    stopped stage 0                                     application: hello-world, group: health-check\n12:34:29.607 kernel  info    leaving kernel with exit code 0                     application: hello-world, group: health-check\n"}),"\n",(0,t.jsxs)(l.p,{children:["Note that the kernel waits the ",(0,t.jsx)(l.code,{children:"wait_interval"})," and checks the health of the application's modules several times:"]}),"\n",(0,t.jsx)(l.pre,{children:(0,t.jsx)(l.code,{className:"language-stdout",children:"12:34:26.605 kernel  info    waiting for module hello-world in stage 2048 to get healthy  application: hello-world, group: health-check\n12:34:27.605 kernel  info    waiting for module hello-world in stage 2048 to get healthy  application: hello-world, group: health-check\n12:34:28.606 kernel  info    waiting for module hello-world in stage 2048 to get healthy  application: hello-world, group: health-check\n"})})]})}function d(e={}){const{wrapper:l}={...(0,h.R)(),...e.components};return l?(0,t.jsx)(l,{...e,children:(0,t.jsx)(s,{...e})}):s(e)}}}]);