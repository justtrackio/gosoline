"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[4951],{9701(e,s,n){n.r(s),n.d(s,{assets:()=>d,contentTitle:()=>a,default:()=>g,frontMatter:()=>t,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"how-to/logging/sampling-and-fingers-crossed","title":"Sampling & fingers-crossed","description":"Gosoline supports log sampling and \\"fingers-crossed\\" logging to help you manage log volume without losing critical debug information when errors occur.","source":"@site/docs/how-to/logging/sampling-and-fingers-crossed.mdx","sourceDirName":"how-to/logging","slug":"/how-to/logging/sampling-and-fingers-crossed","permalink":"/gosoline/how-to/logging/sampling-and-fingers-crossed","draft":false,"unlisted":false,"editUrl":"https://github.com/justtrackio/gosoline/tree/main/docs/docs/how-to/logging/sampling-and-fingers-crossed.mdx","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4,"title":"Sampling & fingers-crossed"},"sidebar":"docSidebar","previous":{"title":"Use loggers","permalink":"/gosoline/how-to/logging/use-loggers"},"next":{"title":"Use context with logs","permalink":"/gosoline/how-to/logging/log-context"}}');var l=n(4848),o=n(8453),r=n(3457);const t={sidebar_position:4,title:"Sampling & fingers-crossed"},a=void 0,d={},c=[{value:"What is fingers-crossed logging?",id:"what-is-fingers-crossed-logging",level:2},{value:"How it works",id:"how-it-works",level:2},{value:"Enable sampling",id:"enable-sampling",level:2},{value:"Configuration",id:"configuration",level:3},{value:"Application Options",id:"application-options",level:3},{value:"Usage in HTTP Services",id:"usage-in-http-services",level:2},{value:"Decision flow",id:"decision-flow",level:3},{value:"What gets flushed (and when)",id:"what-gets-flushed-and-when",level:3},{value:"Usage in Stream Consumers",id:"usage-in-stream-consumers",level:2},{value:"Decision flow",id:"decision-flow-1",level:3},{value:"What gets flushed (and when)",id:"what-gets-flushed-and-when-1",level:3},{value:"Manual Usage",id:"manual-usage",level:2},{value:"Key API Methods",id:"key-api-methods",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"&quot;I don&#39;t see any logs&quot;",id:"i-dont-see-any-logs",level:3},{value:"&quot;Why did it flush?&quot;",id:"why-did-it-flush",level:3}];function h(e){const s={code:"code",em:"em",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(s.p,{children:'Gosoline supports log sampling and "fingers-crossed" logging to help you manage log volume without losing critical debug information when errors occur.'}),"\n",(0,l.jsx)(s.h2,{id:"what-is-fingers-crossed-logging",children:"What is fingers-crossed logging?"}),"\n",(0,l.jsxs)(s.p,{children:["Fingers-crossed logging is a strategy where logs are ",(0,l.jsx)(s.strong,{children:"buffered"})," for a request instead of being written immediately."]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"If the request completes successfully, the buffered logs (usually verbose debug/info logs) are discarded."}),"\n",(0,l.jsxs)(s.li,{children:["If an ",(0,l.jsx)(s.strong,{children:"error"})," occurs (or the request fails), the entire buffer is flushed, preserving the full history of what led to the failure."]}),"\n"]}),"\n",(0,l.jsxs)(s.p,{children:["This allows you to run with high-verbosity logging (like ",(0,l.jsx)(s.code,{children:"debug"})," level) in production for sampled traffic or failed requests, while keeping log costs low for successful, non-sampled traffic."]}),"\n",(0,l.jsx)(s.h2,{id:"how-it-works",children:"How it works"}),"\n",(0,l.jsx)(s.p,{children:"The logic depends on two conditions:"}),"\n",(0,l.jsxs)(s.ol,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Logger Sampling is Enabled"}),": The logger must be configured with sampling enabled."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Context is Not Sampled"}),": The request context must have a sampling decision of ",(0,l.jsx)(s.code,{children:"false"}),"."]}),"\n"]}),"\n",(0,l.jsxs)(s.table,{children:[(0,l.jsx)(s.thead,{children:(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.th,{children:"Sampling Decision"}),(0,l.jsx)(s.th,{children:"Logger Behavior"})]})}),(0,l.jsxs)(s.tbody,{children:[(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{children:(0,l.jsx)(s.code,{children:"Sampled: true"})}),(0,l.jsxs)(s.td,{children:[(0,l.jsx)(s.strong,{children:"Standard"}),": Logs are written immediately."]})]}),(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{children:(0,l.jsx)(s.code,{children:"Sampled: false"})}),(0,l.jsxs)(s.td,{children:[(0,l.jsx)(s.strong,{children:"Fingers-crossed"}),": Logs are buffered in the context scope. They flush only on error."]})]})]})]}),"\n",(0,l.jsx)(s.h2,{id:"enable-sampling",children:"Enable sampling"}),"\n",(0,l.jsx)(s.h3,{id:"configuration",children:"Configuration"}),"\n",(0,l.jsx)(s.p,{children:"You can enable sampling in your application configuration. You also need to configure a sampling strategy (decider) so the system knows which requests to sample."}),"\n",(0,l.jsx)(s.pre,{children:(0,l.jsx)(s.code,{className:"language-yaml",children:'# Sampling decision configuration.\n#\n# The sampling decider reads `sampling.enabled` and `sampling.strategies`.\n# If sampling is enabled, the decider stores the final decision in the context.\n#\n# Available built-in strategies:\n# - "tracing": uses the trace sampling flag from the context\n# - "always": always sample\n# - "never": never sample\n# - "probabilistic": samples a small percentage of requests and guarantees at least one sampled decision per time window\nsampling:\n  enabled: true\n  strategies:\n    - tracing\n'})}),"\n",(0,l.jsxs)(s.p,{children:["Logger sampling itself is enabled via application option ",(0,l.jsx)(s.code,{children:"app.WithSampling"})," (see next section)."]}),"\n",(0,l.jsx)(s.h3,{id:"application-options",children:"Application Options"}),"\n",(0,l.jsx)(s.p,{children:"When setting up your application, ensure you enable the sampling option."}),"\n",(0,l.jsxs)(s.p,{children:["This enables sampling on the logger and also propagates the sampling decision across stream messages via the message attribute ",(0,l.jsx)(s.code,{children:"sampled"}),"."]}),"\n",(0,l.jsx)(s.pre,{children:(0,l.jsx)(s.code,{className:"language-go",children:"app.Run(\n    // ...\n    app.WithSampling,\n)\n"})}),"\n",(0,l.jsx)(s.h2,{id:"usage-in-http-services",children:"Usage in HTTP Services"}),"\n",(0,l.jsxs)(s.p,{children:["The HTTP server provides a ",(0,l.jsx)(s.code,{children:"SamplingMiddleware"})," that integrates automatically with the sampling decider and the logger."]}),"\n",(0,l.jsx)(s.h3,{id:"decision-flow",children:"Decision flow"}),"\n",(0,l.jsx)(s.p,{children:"For each incoming request, gosoline makes a sampling decision early in the request lifecycle."}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"It first ensures there is a place to buffer logs (the fingers-crossed scope)."}),"\n",(0,l.jsxs)(s.li,{children:["If the request includes the ",(0,l.jsx)(s.code,{children:"X-Goso-Sampled"})," header, it is used first as an override.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Values are parsed using ",(0,l.jsx)(s.code,{children:"strconv.ParseBool"})," (e.g. ",(0,l.jsx)(s.code,{children:"true"}),"/",(0,l.jsx)(s.code,{children:"false"}),", ",(0,l.jsx)(s.code,{children:"1"}),"/",(0,l.jsx)(s.code,{children:"0"}),")."]}),"\n",(0,l.jsx)(s.li,{children:"If the header is missing, the configured strategies decide."}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.li,{children:"The decision is attached to the request context so every log call during request handling can use it."}),"\n"]}),"\n",(0,l.jsx)(s.h3,{id:"what-gets-flushed-and-when",children:"What gets flushed (and when)"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Sampled request"}),": logs are written immediately."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Not sampled request"}),": logs are buffered and only become visible when the request fails."]}),"\n",(0,l.jsxs)(s.li,{children:['For HTTP, "fails" means the response status code is ',(0,l.jsx)(s.strong,{children:">= 400"}),", which causes gosoline to flush the buffered logs at the end of the request."]}),"\n"]}),"\n",(0,l.jsx)(s.p,{children:"This means you can keep successful, not-sampled requests quiet, but still get full context for failed requests."}),"\n",(0,l.jsx)(s.h2,{id:"usage-in-stream-consumers",children:"Usage in Stream Consumers"}),"\n",(0,l.jsx)(s.p,{children:"Stream consumers use the same idea, but apply it to message processing."}),"\n",(0,l.jsxs)(s.p,{children:["When publishing messages, gosoline can attach the sampling decision to message attributes (attribute ",(0,l.jsx)(s.code,{children:"sampled"}),"). Consumers can then restore the decision from the message and use it for fingers-crossed logging."]}),"\n",(0,l.jsx)(s.h3,{id:"decision-flow-1",children:"Decision flow"}),"\n",(0,l.jsx)(s.p,{children:"For each message:"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Gosoline ensures there is a fingers-crossed scope, so logs can be buffered."}),"\n",(0,l.jsxs)(s.li,{children:["If the incoming message contains the attribute ",(0,l.jsx)(s.code,{children:"sampled"}),", gosoline parses it (via ",(0,l.jsx)(s.code,{children:"strconv.ParseBool"}),") and attaches the decision to the context.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"This propagated decision takes precedence over any locally configured sampling strategies."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["If no ",(0,l.jsx)(s.code,{children:"sampled"})," attribute is present, gosoline falls back to your configured sampling decider (",(0,l.jsx)(s.code,{children:"sampling.enabled"})," / ",(0,l.jsx)(s.code,{children:"sampling.strategies"}),") to make the decision."]}),"\n"]}),"\n",(0,l.jsx)(s.h3,{id:"what-gets-flushed-and-when-1",children:"What gets flushed (and when)"}),"\n",(0,l.jsx)(s.p,{children:'Because consumers do not have an HTTP response status, the "fail" signal is usually an error log:'}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Sampled message"}),": logs are written immediately."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Not sampled message"}),": logs are buffered and flush when you log an error (or if you flush manually via ",(0,l.jsx)(s.code,{children:"log.FlushFingersCrossedScope(ctx)"}),")."]}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"manual-usage",children:"Manual Usage"}),"\n",(0,l.jsx)(s.p,{children:"If you are writing a custom worker, CLI tool, or background process, you can use the fingers-crossed features manually."}),"\n",(0,l.jsx)(r.A,{showLineNumbers:!0,language:"go",title:"main.go",children:'package main\n\nimport (\n\t"context"\n\t"fmt"\n\t"os"\n\n\t"github.com/justtrackio/gosoline/pkg/cfg"\n\t"github.com/justtrackio/gosoline/pkg/clock"\n\t"github.com/justtrackio/gosoline/pkg/log"\n\t"github.com/justtrackio/gosoline/pkg/smpl/smplctx"\n)\n\nfunc main() {\n\t// 1. Create a logger with sampling enabled\n\thandler := log.NewHandlerIoWriter(cfg.New(), log.PriorityDebug, log.FormatterConsole, "main", "15:04:05.000", os.Stdout)\n\tlogger := log.NewLoggerWithInterfaces(clock.NewRealClock(), []log.Handler{handler})\n\n\tif err := logger.Option(log.WithSamplingEnabled(true)); err != nil {\n\t\tpanic(err)\n\t}\n\n\t// 2. Prepare a context that is NOT sampled (to trigger buffering)\n\t// In a real app, this decision comes from the sampling middleware or decider.\n\tctx := context.Background()\n\tctx = smplctx.WithSampling(ctx, smplctx.Sampling{Sampled: false})\n\n\t// 3. Add the fingers-crossed scope to the context\n\t// This scope will buffer logs until an error occurs or it is flushed.\n\tctx = log.WithFingersCrossedScope(ctx)\n\n\tfmt.Println("--- Phase 1: Logging Info (buffered, should not appear yet) ---")\n\tlogger.Info(ctx, "This is an info message (buffered)")\n\tlogger.Debug(ctx, "This is a debug message (buffered)")\n\n\tfmt.Println("--- Phase 2: Logging Error (triggers flush) ---")\n\t// This error log will cause the buffer to flush, printing the previous messages + the error.\n\tlogger.Error(ctx, "An error occurred!")\n\n\tfmt.Println("--- Phase 3: Done ---")\n}\n'}),"\n",(0,l.jsx)(s.h3,{id:"key-api-methods",children:"Key API Methods"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:(0,l.jsx)(s.code,{children:"app.WithSampling"})}),": Enables the sampling logic on the logger."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:(0,l.jsx)(s.code,{children:"log.WithFingersCrossedScope(ctx)"})}),": Wraps the context with a buffer for fingers-crossed logging."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:(0,l.jsx)(s.code,{children:"log.FlushFingersCrossedScope(ctx)"})}),": Manually flushes any buffered logs in the current scope."]}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,l.jsx)(s.h3,{id:"i-dont-see-any-logs",children:'"I don\'t see any logs"'}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:[(0,l.jsx)(s.strong,{children:"Did you add a scope?"}),"\nIf sampling is enabled on the logger, and the context is ",(0,l.jsx)(s.em,{children:"not"})," sampled, the logger expects a fingers-crossed scope to buffer into. If you didn't call ",(0,l.jsx)(s.code,{children:"log.WithFingersCrossedScope(ctx)"}),", the logs may be dropped because there is nowhere to buffer them."]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:[(0,l.jsx)(s.strong,{children:"Is the context sampled?"}),"\nIf ",(0,l.jsx)(s.code,{children:"smplctx.IsSampled(ctx)"})," is true (which is the default for empty contexts), logs write immediately. You won't see buffering behavior."]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h3,{id:"why-did-it-flush",children:'"Why did it flush?"'}),"\n",(0,l.jsx)(s.p,{children:"The buffer flushes when:"}),"\n",(0,l.jsxs)(s.ol,{children:["\n",(0,l.jsxs)(s.li,{children:["You log a message with level ",(0,l.jsx)(s.code,{children:"Error"})," or higher."]}),"\n",(0,l.jsxs)(s.li,{children:["You manually call ",(0,l.jsx)(s.code,{children:"log.FlushFingersCrossedScope(ctx)"}),"."]}),"\n",(0,l.jsx)(s.li,{children:"(In HTTP) The response status code is >= 400."}),"\n"]})]})}function g(e={}){const{wrapper:s}={...(0,o.R)(),...e.components};return s?(0,l.jsx)(s,{...e,children:(0,l.jsx)(h,{...e})}):h(e)}}}]);